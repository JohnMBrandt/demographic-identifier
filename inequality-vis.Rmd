---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
library(ggplot2)
library(directlabels)
library(dplyr)

# Read in data and scale
data <- read.csv("stat_full.csv")


data <- data %>%
  group_by(continent) %>%
  mutate(PM25_cont = percent_rank(PM25),
         INC_cont = percent_rank(INCOME_STD)) %>%
  mutate(rank_percent = percent_rank(PM25_cont/INC_cont)*100) %>%
  mutate(binspm = cut(PM25_cont, 10, labels=F),
         binsinc = cut(INC_cont, 10, labels=F)) %>%
  group_by(continent) %>%
  tidyr::drop_na(PM25) %>%
  tidyr::drop_na(INCOME_STD) %>%
  mutate(PM_perc = PM25/max(PM25, na.omit=T), INC_perc = INCOME_STD/max(INCOME_STD, na.omit=T)) %>%
  filter(PM_perc > 0.001, INC_perc > 0.001) %>%
  mutate(PM.INC.rank = PM_perc/INC_perc) %>%
  mutate(PM.INC.rank = round(PM.INC.rank/max(PM.INC.rank),1)) %>%
  group_by(continent) %>%
  select(continent, PM.INC.rank) %>%
  na.omit() %>%
  mutate(total = n()) %>%
  ungroup() %>%
  group_by(continent) %>%
  mutate(maxtotal = max(total)) %>%
  ungroup() %>%
  group_by(continent, PM.INC.rank, total, maxtotal) %>%
  summarize(n=n()) %>%
  mutate(perc = n/(total/maxtotal)) %>%
  ungroup() %>%
  group_by(PM.INC.rank) %>%
  mutate(total_perc = sum(perc)) %>%
  mutate(final_percent = perc/total_perc)
  
data_sum$continent <- as.character(data_sum$continent)
data_sum[59,] <- c("oceana", 0.1, 1, 1, 1, 1, 1, 0.00)
data_sum[60,] <- c("oceana", 0.2, 1, 1, 1, 1, 1, 0.00)
data_sum[61,] <- c("oceana", 0.0, 1, 1, 1, 1, 1, 0.00)
data_sum[62,] <- c("south_america", 0.0, 1, 1, 1, 1, 1, 0.00)
data_sum[63,] <- c("asia", 0.1, 1, 1, 1, 1, 1, 0.00)
data_sum[64,] <- c("asia", 0.7, 1, 1, 1, 1, 1, 0.00)
data_sum[65,] <- c("north_america", 0.3, 1, 1, 1, 1, 1, 0.00)
data_sum[66,] <- c("north_america", 0.9, 1, 1, 1, 1, 1, 0.00)
data_sum$final_percent[data_sum$continent == "oceana" && data_sum$percrank == 0.3] <- 0
data_sum[41,8] <- 0
data_sum[16,8] <- 0.06


data_sum <- as.data.frame(data_sum)
data_sum$final_percent <- as.numeric(data_sum$final_percent)
data_sum$final_percent <- round(data_sum$final_percent, 2)
data_sum$continent <- as.factor(data_sum$continent)
data_sum$percrank <- as.numeric(data_sum$percrank)
data_sum$final_percent <- round(data_sum$final_percent, 2)


#data_sum <- data_sum[order(data_sum$continent),]
p1 <- ggplot(data = data_sum, aes(x=percrank*100, y=final_percent*100))+
  geom_area(aes(fill=continent))+
  #geom_dl(aes(label=continent), method="top.bumpup")+
  scale_x_continuous(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0), limits = c(0,100))+
  scale_fill_brewer(palette="Spectral")+
  ylab("Percentage of neighborhoods")+
  theme(axis.text.y=element_blank(), axis.ticks.y = element_blank())+
  xlab("Percent ratio of PM 2.5 : Income")

p1data <- ggplot_build(p1)
p1data <- p1data$data[[1]]
p1data <- p1data %>%
  filter(xmin == 100)

p2 <- p1+annotate("text", x=p1data$xmax+20, y=p1data$ymax-5, label = c("South America", "Oceania", "North America", "Europe", "Asia", "Africa"), hjust=c(1,1.75,1,2,3.3,2.5), color = p1data$fill)+theme_minimal()+theme(legend.position="none", axis.title.x = element_text(hjust=0.4), panel.grid = element_blank())+
  scale_x_continuous(expand=c(0,0), breaks=c(0,25,50,75, 100), labels=c(0,25,50, 75,100))
print(p2)
```